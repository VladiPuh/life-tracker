# LifeTracker — Канон проекта (v1.2)

## 0. Статус

Документ пересобран с учётом актуального состояния системы и нерешённых UX-вопросов. Фиксирует **факты**, **открытые проблемы**, **архитектурные решения** и **вектор развития**. Является источником истины для продолжения работы в новых чатах.

---

## 1. Назначение проекта

LifeTracker — Telegram Mini App для отслеживания личных челенджей (привычки, обучение, задачи) с ежедневной отметкой статуса.

Ключевая идея:

- стабильный Mini App как основной интерфейс
- фокус на предсказуемый UX
- минимальная, понятная архитектура

Веб-доступ вне Telegram используется **только для отладки**.

---

## 2. Архитектура (фактическая)

```
Telegram Client (iOS / Android)
   |
   | Telegram Mini App (Main App)
   v
https://life-tracker.pages.dev/app/
   |
   | fetch('/api/*') + X-Telegram-Init-Data
   v
https://life-tracker.pages.dev/api/
   |  (reverse proxy)
   v
FastAPI (127.0.0.1:8000) → SQLite
```

Принципы:

- один домен
- относительные пути
- отсутствие CORS

---

## 3. Frontend (Mini App)

### Стек

- React
- TypeScript
- Vite
- Telegram WebApp API

### Репозиторий / структура

```
D:\Life-Tracker\apps\webapp
├─ src/App.tsx
├─ public/
├─ dist/
└─ vite.config.ts
```

### Канон

- `API_BASE = "/api"`
- все API-запросы только при `tgOk === true`
- initData читается централизованно
- DEBUG не должен присутствовать в PROD

---

## 4. Backend (API)

### Стек

- Python 3.10
- FastAPI
- Uvicorn
- SQLite

### Серверное размещение

```
/opt/lifetracker/api
├─ app/main.py
├─ life_tracker.db
├─ .venv/
└─ uvicorn.log
```

API слушает:

- `127.0.0.1:8000`

Доступ извне:

- `https://life-tracker.pages.dev/api/*`

---

## 5. Авторизация

### PROD (канон)

- источник: Telegram WebApp `initData`
- передача: заголовок `X-Telegram-Init-Data`
- отсутствие заголовка → 401 (норма)

### DEV

- фиксированный пользователь
- только локально

---

## 6. nginx

Функции:

- HTTPS (Let’s Encrypt)
- раздача фронта: `https://life-tracker.pages.dev/app/`
- reverse proxy `/api/` → `127.0.0.1:8000`

nginx не содержит бизнес-логики.

---

## 7. Telegram Mini App — режимы запуска

### Main App (используется)

- основной способ запуска
- URL: `https://life-tracker.pages.dev/`
- Launch Mode: **Fullscreen**

Особенность iOS:

- fullscreen не всегда применяется автоматически
- требуется `tg.expand()` / `tg.requestFullscreen()`

---

## 8. TODAY / DETAIL — текущая UX-проблема (ОТКРЫТА)

### Симптом

- DETAIL → системный Telegram «Назад»
- список `today.all` остаётся развернутым

### Текущее состояние

- реализован перехват `Telegram.BackButton`
- реализован сброс `showAll` при переходах экранов
- **проблема всё ещё воспроизводится на iOS**

### Вывод

Проблема **НЕ закрыта**. Требуется дополнительное исследование:

- различие между системным Back (iOS) и WebApp BackButton
- влияние history/navigation внутри Telegram

---

## 9. React-правила (жёсткий канон)

- хуки (`useEffect`) только на верхнем уровне
- любые возвраты на TODAY → явный сброс UI-состояния
- нельзя полагаться на системную навигацию Telegram без явной синхронизации

---

## 10. Деплой (канон)

### Frontend

1. `npm run build`
2. деплой `dist/` на хостинг
3. проверка **только внутри Telegram**

### Backend

- запуск: `nohup uvicorn`
- перезапуск: `kill PID` → запуск

---

## 11. Сервер и доступ

- Провайдер: reg.ru / per.oblako
- Публичный IP: `95.163.227.121`
- Пользователь: `root`
- SSH-ключ: `~/.ssh/lifetracker`

---

## 12. Тестирование (фактическое)

### Проверено

- health OK
- авторизация через initData работает
- добавление шаблонов создаёт активные челенджи

### НЕ подтверждено (открыто)

- корректное сворачивание списка при системном Back на iOS

---

## 13. Планы, цели, развитие (ВОЗВРАЩЕНО И РАСШИРЕНО)

### Краткосрочно

- полностью зафиксировать поведение системной кнопки «Назад»
- убрать DEBUG из PROD полностью
- стабилизировать fullscreen-поведение на iOS

### Среднесрочно

- ввести явную навигационную модель (state machine экранов)
- добавить анимации переходов (визуальная ясность)
- офлайн-индикаторы / graceful errors

### Долгосрочно

- история прогресса (неделя / месяц)
- экспорт данных
- мульти-девайс синхронизация
- расширение системы челенджей (цепочки, условия)

---

## 14. Принципы проекта

1. Один шаг за раз
2. Фиксируем факты, не предположения.
3. UX важнее локальной элегантности кода, но в процессе работы с кодом можем его отпимизировать
4. Инфраструктура — максимально скучная
5. Канон всегда догоняет реальность

---

## 15. Статус на момент фиксации

- Backend: стабилен
- Frontend: функционален
- Main App + Fullscreen: включено, требует доводки
- Критическая UX-проблема: **ещё не закрыта**

---

**Конец канона v1.3**
