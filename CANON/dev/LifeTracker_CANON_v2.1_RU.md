# LifeTracker — CANON v2.1 (RU)

> **Единый источник истины (Single Source of Truth)**  
> Этот документ фиксирует текущее состояние, архитектуру и правила развития проекта **LifeTracker**.
> Любая работа ведётся **строго по этому канону**.  
> Версия: **v2.1**

---

## 0. Контекст проекта

**LifeTracker** — Telegram Mini App для отслеживания ежедневных челенджей
(привычки, обучение, задачи, микро-цели).

Ключевая идея:

- минимальное трение,
- ежедневное действие важнее «идеального выполнения»,
- система должна масштабироваться **без архитектурного хаоса**.

Проект развивается итеративно, с приоритетом:
**архитектура → стабильность → UX**, а не наоборот.

---

## 1. Текущее состояние (зафиксированные факты)

### 1.1 Production

- Backend и Frontend работают в **PROD**
- Telegram Mini App настроен как **Main App / Fullscreen**
- Авторизация через **Telegram initData** подтверждена
- `API_BASE = /api`
- Добавление шаблонов и появление челенджей работает
- Фронт деплоится в: `/var/www/html/app`

### 1.2 Деплой фронта (формализован)

- PowerShell-скрипт: `deploy_frontend.ps1`
- SSH по ключу
- Архивация `dist/ → tar.gz`
- Обязательный **серверный бэкап** перед заменой

### 1.3 UX-известные проблемы

- iOS Back / сворачивание списка TODAY
- Проблема **осознанно отложена**
- Зафиксирована и **не лечится до завершения архитектурных этапов**

---

## 2. Ключевая смена фокуса (v2.0 → v2.1)

Мы **прекратили точечную борьбу с симптомами UX**
и перешли к архитектурному этапу.

Текущий фокус:

- ❌ не «починить кнопку»
- ❌ не «заставить back работать»
- ✅ чистая архитектура
- ✅ явные слои ответственности
- ✅ подготовка проекта к росту

**v2.1 = фиксация архитектурной зрелости фронта + начало чистки backend.**

---

## 3. Frontend — итоговая архитектура v2.1

### 3.1 Целевая структура (достигнута)

```
src/
  app/              # app-shell, навигация, эффекты
  features/         # экраны (UI без логики)
    today/
    detail/
    templates/
    add/
  state/            # state-layer + side-effects
    today.ts
    detail.ts
    templates.ts
    add.ts
  shared/            # инфраструктура
    api/
      client.ts
      lifetracker.ts
    tg/
      initData.ts
      webapp.ts
    ui/
    domain/
```

### 3.2 App.tsx — правила

`App.tsx` **НЕ ДОЛЖЕН**:

- содержать JSX экранов
- вызывать API напрямую
- хранить бизнес-логику

`App.tsx` **МОЖЕТ**:

- связывать state + features
- управлять навигацией
- содержать эффекты среды (Telegram / browser)

---

## 4. State-layer (введён в v2.1)

### Принципы

- Без Redux / Zustand / внешних библиотек
- Каждый domain — отдельный hook
- State владеет side-effects (API)
- UI (features) — тупой, декларативный

### Реализовано

- `useTodayState`
- `useDetailState`
- `useTemplatesState`
- `useAddState`

Это **точка невозврата** из монолита.

---

## 5. Telegram SDK слой

- Весь Telegram SDK изолирован в `shared/tg/*`
- `App.tsx` не знает о `window.Telegram`
- BackButton, ready, expand — через единый шлюз

---

## 6. Backend — текущее состояние (as-is)

### Факты

- FastAPI backend
- Основная логика сосредоточена в `main.py`
- Присутствуют дубли и следы ручной эволюции
- Возможны дубли SQLite БД
- Поведение **стабильно**, но архитектура хрупкая

---

## 7. Этап 1.5 — Backend package-cleanup (начат)

### Цель

- разнести `main.py` на пакеты
- без изменения поведения
- подготовить backend к росту и тестируемости

### План

1. Диагностика `main.py` (as-is)
2. Введение пакетов:
   - `routers`
   - `services`
   - `repositories`
   - `core`
3. Механический вынос (по одному файлу)
4. Уборка мусора и дубликатов

---

## 8. Принципы работы (обязательные)

- **Один шаг за раз**
- Сначала диагностика → потом код
- Минимальные правки, максимальная ясность
- Архитектура важнее симптомов
- После серии изменений — уборка
- Если нужен деплой — команды даются сразу

---

## 9. Роль ассистента в проекте

Ассистент — **главный архитектор-перфекционист**, который:

- показывает **КАК делать правильно**
- объясняет **ПОЧЕМУ**, без воды
- не перескакивает шаги
- не лечит симптомы вместо причин
- помогает фиксировать канон и точки решений

---

## 10. Статус канона

- v2.0 — переход от UX-борьбы к архитектуре
- **v2.1 — зафиксированная чистая архитектура фронта + старт backend-этапа**

Любые изменения **обновляют этот документ**.

---

**Конец канона v2.1**
