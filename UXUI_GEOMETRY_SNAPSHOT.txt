== Life-Tracker UX/UI Geometry Snapshot ==
Root: D:\Life-Tracker

===== FILE: apps/webapp/index.html =====
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>webapp</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

===== FILE: apps/webapp/src/main.tsx =====
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)

===== FILE: apps/webapp/src/App.tsx =====
import { getInitData } from "./shared/tg/initData";
import { useEffect, useState } from "react";
import {
  hasTelegramWebApp,
  initTelegram,
  logTelegramReady,
  bindTelegramBackButton,
} from "./shared/tg/webapp";
import { useNav } from "./app/router/useNav";
import { useBack } from "./app/router/useBack";

import DetailScreen from "./features/detail/DetailScreen";
import { TemplatesScreen } from "./features/templates/TemplatesScreen";
import { useTemplatesState } from "./state/templates";
import { AddScreen } from "./features/add/AddScreen";
import { useTodayState } from "./state/today";
import { useAddState } from "./state/add";

import { TodayPage } from "./pages/TodayPage";
import MyChallengesPage from "./pages/MyChallengesPage";
import { HistoryPage } from "./pages/HistoryPage";

type TabId = "insights" | "history" | "today" | "new" | "templates" | "profile";
type PlaceholderKind = "INSIGHTS" | "PROFILE";

function PlaceholderCard(props: { title: string; text: string }) {
  return (
    <div
      style={{
        padding: 12,
        border: "1px solid rgba(0,0,0,0.08)",
        borderRadius: 12,
        marginTop: 12,
      }}
    >
      <div style={{ fontWeight: 700, marginBottom: 6 }}>{props.title}</div>
      <div style={{ opacity: 0.75, lineHeight: 1.35 }}>{props.text}</div>
    </div>
  );
}

function BottomNav(props: {
  active: TabId;
  onGo: (tab: TabId) => void;
}) {
  const Item = (p: {
    id: TabId;
    label: string;
    emphasize?: boolean;
    onClick: () => void;
  }) => {
    const isActive = props.active === p.id;

    return (
      <button
        onClick={p.onClick}
        style={{
          flex: 1,
          padding: "10px 6px",
          border: "none",
          background: "transparent",
          cursor: "pointer",
          opacity: isActive ? 1 : 0.6,
          fontWeight: p.emphasize ? 800 : 600,
          letterSpacing: p.emphasize ? -0.2 : 0,
        }}
        aria-label={p.label}
        title={p.label}
      >
        {p.label}
      </button>
    );
  };

  return (
    <div
      style={{
        position: "sticky",
        bottom: 0,
        marginTop: 14,
        paddingTop: 10,
        paddingBottom: 10,
        background: "rgba(255,255,255,0.92)",
        backdropFilter: "blur(8px)",
        borderTop: "1px solid rgba(0,0,0,0.08)",
        display: "flex",
        gap: 6,
      }}
    >
      <Item id="insights" label="Инсайты" onClick={() => props.onGo("insights")} />
      <Item id="history" label="История" onClick={() => props.onGo("history")} />
      <Item id="today" label="Сегодня" emphasize onClick={() => props.onGo("today")} />
      <Item id="new" label="Новый" emphasize onClick={() => props.onGo("new")} />
      <Item id="templates" label="Шаблоны" onClick={() => props.onGo("templates")} />
      <Item id="profile" label="Профиль" onClick={() => props.onGo("profile")} />
    </div>
  );
}

declare const __BUILD_ID__: string;

export default function App() {
  const [selectedId, setSelectedId] = useState<number | null>(null);
  const [err, setErr] = useState<string | null>(null);

  // Заглушки для будущих экранов (честно, без “перекидывания в Today”)
  const [placeholder, setPlaceholder] = useState<PlaceholderKind | null>(null);

  const { showAll, loadToday, resetShowAll } = useTodayState();

  const tgPresent = hasTelegramWebApp();
  const initData = getInitData();
  const initLen = initData.length;
  const tgOk = tgPresent && initLen > 0;

  const { screen, go, goToday } = useNav();

  const { templates, addTemplate } = useTemplatesState();
  const { newTitle, setNewTitle, newDesc, setNewDesc, newMissPolicy, setNewMissPolicy, create } =
    useAddState();

  useEffect(() => {
    if (screen === "TODAY") {
      resetShowAll();
    }
  }, [screen, resetShowAll]);

  useEffect(() => {
    if (!tgPresent) return;
    initTelegram();
    logTelegramReady();
  }, [tgPresent]);

  useEffect(() => {
    console.log("[DBG] screen=", screen, "showAll=", showAll, "placeholder=", placeholder);
  }, [screen, showAll, placeholder]);

  // Back внутри приложения:
  // - если открыт placeholder → закрыть placeholder
  // - иначе обычный back к Today
  useBack({
    enabled: tgOk && (screen !== "TODAY" || placeholder !== null),
    onBack: () => {
      resetShowAll();
      if (placeholder) {
        setPlaceholder(null);
        return;
      }
      goToday();
    },
  });

  // iOS Telegram может дергать history/back без BackButton UI.
  // Наша цель: при любом системном back/history/restore — свернуть список.
  useEffect(() => {
    const onSystemNav = () => {
      resetShowAll();
    };

    window.addEventListener("popstate", onSystemNav);
    window.addEventListener("hashchange", onSystemNav);
    window.addEventListener("pageshow", onSystemNav);

    return () => {
      window.removeEventListener("popstate", onSystemNav);
      window.removeEventListener("hashchange", onSystemNav);
      window.removeEventListener("pageshow", onSystemNav);
    };
  }, [resetShowAll]);

  // Telegram BackButton: показываем, если мы не в чистом Today
  useEffect(() => {
    const shouldShow =
      placeholder !== null ||
      screen === "DETAIL" ||
      screen === "ADD" ||
      screen === "TEMPLATES" ||
      screen === "HISTORY";

    const onTgBack = () => {
      resetShowAll();
      if (placeholder) {
        setPlaceholder(null);
        return;
      }
      goToday();
    };

    return bindTelegramBackButton({
      enabled: tgOk,
      shouldShow,
      onBack: onTgBack,
    });
  }, [tgOk, screen, goToday, resetShowAll, placeholder]);

  // active tab
  const activeTab: TabId =
    placeholder === "INSIGHTS"
      ? "insights"
      : placeholder === "PROFILE"
      ? "profile"
      : screen === "ADD"
      ? "new"
      : screen === "TEMPLATES"
      ? "templates"
      : screen === "HISTORY"
      ? "history"
      : "today";

  return (
    <div style={{ maxWidth: 520, margin: "0 auto", padding: 16, fontFamily: "system-ui, Arial" }}>
      {err && (
        <div style={{ marginTop: 12, padding: 10, border: "1px solid #f99", borderRadius: 8 }}>
          Ошибка: {err}
        </div>
      )}

      {/* PLACEHOLDERS (тихо, без CTA) */}
      {screen === "TODAY" && placeholder === "INSIGHTS" && (
        <PlaceholderCard
          title="Инсайты"
          text="Этот экран появится позже. Сейчас важнее факт и устойчивость."
        />
      )}
      {screen === "TODAY" && placeholder === "PROFILE" && (
        <PlaceholderCard
          title="Профиль"
          text="Этот экран появится позже. Сейчас — только действие и факт."
        />
      )}

      {/* TODAY */}
      {screen === "TODAY" && placeholder === null && (
        <TodayPage onGoChallenges={() => go("CHALLENGES")} />
      )}

      {/* HISTORY */}
      {screen === "HISTORY" && <HistoryPage />}

      {screen === "CHALLENGES" && (
        <MyChallengesPage
          onOpen={(id) => {
            setSelectedId(id);
            go("DETAIL");
          }}
        />
      )}

      {/* DETAIL */}
      {screen === "DETAIL" && selectedId != null && (
        <DetailScreen
          challengeId={selectedId}
          onBack={() => go("CHALLENGES")}
        />
      )}

      {/* TEMPLATES */}
      {screen === "TEMPLATES" && (
        <TemplatesScreen templates={templates} onAdd={(templateId) => addTemplate(templateId)} />
      )}

      {/* ADD */}
      {screen === "ADD" && (
        <AddScreen
          newTitle={newTitle}
          setNewTitle={setNewTitle}
          newDesc={newDesc}
          setNewDesc={setNewDesc}
          newMissPolicy={newMissPolicy}
          setNewMissPolicy={setNewMissPolicy}
          onBack={() => {
            resetShowAll();
            goToday();
          }}
          onCreate={async () => {
            setErr(null);
            try {
              await create();
              await loadToday();
              goToday();
            } catch (e) {
              setErr(String(e));
            }
          }}
        />
      )}

      <BottomNav
        active={activeTab}
        onGo={(tab) => {
          // Заглушки — остаёмся на TODAY, но показываем отдельную “плашку-экран”
          if (tab === "insights") {
            setPlaceholder("INSIGHTS");
            go("TODAY");
            return;
          }
          if (tab === "profile") {
            setPlaceholder("PROFILE");
            go("TODAY");
            return;
          }

          // Реальные экраны — сбрасываем placeholder
          setPlaceholder(null);

          if (tab === "history") return go("HISTORY");
          if (tab === "today") return go("TODAY");
          if (tab === "new") return go("ADD");
          if (tab === "templates") return go("TEMPLATES");
        }}
      />
      <div
        style={{
          marginTop: 14,
          paddingBottom: 6,
          fontSize: 10,
          lineHeight: "10px",
          opacity: 0.28,
          textAlign: "center",
          userSelect: "none",
          pointerEvents: "none",
        }}
      >
        build: {__BUILD_ID__}
      </div>
    </div>
  );
}

===== FILE: apps/webapp/src/index.css =====
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #646cff;
  text-decoration: inherit;
}
a:hover {
  color: #535bf2;
}

body {
  margin: 0;
  display: flex;
  place-items: center;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}

===== FILE: apps/webapp/src/App.css =====
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}

===== FILE: apps/webapp/src/shared/tg/webapp.ts =====
import WebApp from "@twa-dev/sdk";

export function hasTelegramWebApp(): boolean {
  return Boolean((window as any).Telegram?.WebApp);
}

export function getPlatform(): string | undefined {
  try {
    return WebApp?.platform;
  } catch {
    return undefined;
  }
}

export function getSdkInitDataLen(): number {
  try {
    return (WebApp?.initData ?? "").length;
  } catch {
    return 0;
  }
}

export function initTelegram(): void {
  try {
    WebApp.ready(); // РІР°Р¶РЅРѕ РґР»СЏ iOS
  } catch {}
  try {
    WebApp.expand(); // РЅР° РІСЃСЏРєРёР№ СЃР»СѓС‡Р°Р№ (РїР°РЅРµР»СЊ/viewport)
  } catch {}
}

export function logTelegramReady(tag = "[TG] ready"): void {
  try {
    // РґРёР°РіРЅРѕСЃС‚РёС‡РµСЃРєРёР№ Р»РѕРі (РѕСЃС‚Р°РІСЊ РЅР° РІСЂРµРјСЏ С‚РµСЃС‚Р°)
    // eslint-disable-next-line no-console
    console.log(tag, {
      platform: WebApp.platform,
      initDataLen: (WebApp.initData ?? "").length,
      hasBackButton: Boolean(WebApp?.BackButton),
    });
  } catch {}
}

export function bindTelegramBackButton(args: {
  enabled: boolean;
  shouldShow: boolean;
  onBack: () => void;
}): () => void {
  if (!args.enabled) return () => {};

  const bb = WebApp?.BackButton;
  if (!bb) return () => {};

  if (args.shouldShow) {
    try {
      bb.show();
    } catch {}

    bb.onClick(args.onBack);

    return () => {
      try {
        bb.offClick(args.onBack);
      } catch {}
    };
  }

  try {
    bb.hide();
  } catch {}

  return () => {};
}

===== FILE: apps/webapp/src/shared/tg/initData.ts =====
import WebApp from "@twa-dev/sdk";

export function getInitData(): string {
  // 1) РµСЃР»Рё Telegram WebApp СѓР¶Рµ РёРЅРёС†РёР°Р»РёР·РёСЂРѕРІР°Р»СЃСЏ
  const fromWebApp = WebApp?.initData ?? "";
  if (fromWebApp) return fromWebApp;

  // 2) fallback: РµСЃР»Рё Telegram РїРµСЂРµРґР°Р» РґР°РЅРЅС‹Рµ РІ URL hash
  const hash = window.location.hash || "";
  const params = new URLSearchParams(hash.startsWith("#") ? hash.slice(1) : hash);
  return params.get("tgWebAppData") ?? "";
}

